# Linuxの基本コマンド


## 概要

ディレクトリ、ファイル操作を中心としたLinux基本コマンドを扱います

コマンドの補完や履歴、コピー＆ペーストを活用することで手入力による打ち間違いを避けるのがコツです。

- タブキーを素早く２度押すと、利用可能なコマンドやファイル名が補完されます（候補が多すぎて表示しきれない場合 "q" を押すと途中でとめられます）

- 矢印キーの上下で過去に入力したコマンドの履歴が表示できます。

また、誤った操作などによって入力が受け付けなくなってしまった場合には、control-Cを押すことで、処理をキャンセルし入力待機状態に戻ることができる場合があります。"q" を押すことで処理を中断させられる場合もあります。  

## ログインしたら最初にやること

スパコンログイン直後は、スパコンシステム環境への入り口であるゲートウェイノード (gw) にいます。gw では解析処理等を行うことは想定されておらず、負荷の高い処理を行うと他のユーザにも影響がでることがあります。そのため、スパコンにログインした後に
```
qlogin
```
コマンドを実行し、作業用ノード（インタラクティブノード）に移動します。  
スパコンではログインしている間、ターミナルの行の先頭に```[ユーザー名@at029 ~]$```というように表示がされます。この表示をプロンプトといい、プロンプトが表示されているときはコマンドの入力待機状態になっています。`at029`はqloginによってログインしたインタラクティブノードの名称 (qloginするごとに変わる)を示し、`~`の部分は現在自分がホームディレクトリにいることを示します。なお、プロンプトに表示させる情報はカスタマイズすることができます。

qlogin を実行する際に、パスワードが要求されます。スパコンアカウントのパスワードを入力してください（認証鍵を生成するときに指定したパスフレーズとは異なります）。パスワードは`passwd`コマンドを使って変更することが可能です。パスワード入力を回避する方法もあります（後述）。

## ログアウト
`exit`コマンドを実行するか、`ctrlキーを押しながらDキーを押す`ことでログアウトできます。インタラクティブノードにいた場合には、ログアウト後gwノードに戻ります。そこからもう一度ログアウトするとスパコンから切断されます。

## 講習用サンプルファイルの取得
講習用のファイルを取得するために次のコマンドを実行してください。
$ git clone https://github.com/genome-sci/basic_course_2020

## 基本コマンドの実習
 
1. __現在の状況を把握する (pwdとls)__

    `pwd`:  現在自分がいるディレクトリ（フォルダ）を表示します。(print working directory)  
    下記は実行例と、その結果です。"$"の部分はプロンプトを示しますので入力は不要です。
    ```
    $ pwd
    /home/userXXX/ 　# ← 結果。自分のホームディレクトリにいるはずです。
    ```

    `ls`: 現在のディレクトリ内にあるファイルおよびディレクトリの一覧 (list) を表示します。  
    ```
    $ ls
    ```
    さきほど取得した練習用のファイルを含んだ "basic_course" というディレクトリが見えるはずです。
    ```
    $ ls basic_course
    ```
    とするとbasic_courseの中身が表示されます。

    不可視ファイル ( . で始まるもの）を含めて表示させるには次のようにします。
    ```
    $ ls -a
    ```
    このコマンドによって表示されたディレクトリのうち、"." は現在のディレクトリ、".." は一つ上の階層のディレクトリ（親ディレクトリ）を示します。  
    "-a" はコマンドラインオプションのひとつです。UNIX のコマンドの多くはコマンドラインオプションを使うことで、既定の動作を変更させることができます。

    `-l`オプションを使うとファイルの更新日時やファイルサイズも含めて表示できます。
    ```
    $ ls -a -l
    ```
    上記は `ls -al` としても同様の結果が得られます。
    また、多くのシステムでは `ll` が `ls -l` のショートカットとして利用できます。

    ```
    $ ls --help
    ```
    多くのコマンドでは `-h` `-help` `--help` などのオプションをつけることでヘルプを表示できます。


2. __ディレクトリの移動 (cd)__

    ディレクトリを移動します。
    ```
    $ cd basic_course/
    ```
    一つ上のディレクトリ（もとのディレクトリ）に戻るには、”..”を指定します。
    ```
    $ cd ..
    ```

    ホームディレクトリに戻るには
    ```
    $ cd
    ```
    または
    ```
    $ cd ~
    ```
    とします。`~`はホームディレクトリを示す記号です。

    直前にいたディレクトリに戻る時には
    ```
    $ cd -
    ```  
    を実行します。

3. __Linuxのディレクトリの基本構造__

    - `/` ルートディレクトリ。ファイルシステムの最上層の階層  
    - `/bin` おもにシステムの動作に最低限必要な実行ファイルを格納する
    - `/usr` 各種アプリケーションと、それに付随するファイルを格納する
        - `/usr/local/biotools` 各種生命科学用ツールのsingularityイメージが格納されている
        - `/usr/local/pkg/` NIGスパコンではPythonなどプログラミング言語がバージョンごとに置かれている
        - `/usr/local/seq/` NIGスパコンではDDBJの塩基配列データやBLASTデータベースが置かれている
    - `/home` 各ユーザーごとのホームディレクトリが格納されている
        - `/home/userXXX/` userXXXのホームディレクトリ
        - `/home/userYYY/` userYYYのホームディレクトリ
        - `/home/userZZZ/` userZZZのホームディレクトリ

    UNIX/Linuxではファイルやディレクトリごとに所有者や書き込み・読み込み権限（パーミッション）が設定されており、通常は他のユーザーからはファイルが見られないようになっています。
    同じグループに属するユーザーであれば一般的には閲覧可能です。
    自分が所有するファイルであれば`chmod`コマンドを使って権限を変更することも可能です。


4. __絶対パスと相対パス__

    ルートディレクトリ`/`を起点にした場所の示し方を「絶対パス」と呼びます。
    例えば、次のようにディレクトリを指定するのが絶対パスを使った方法です。
    ```
    $ cd /usr/local/bin
    ```

    これに対して、今いる自分のディレクトリからの相対的な場所を示したものが「相対パス」です。例えば、"/usr/local/bin" から "/usr/local/biotools" ディレクトリに移るには、１つ上の階層に移動した後に"biotools"に移ることになりますが、これを一回で行うときには相対パスを使ってつぎのようにすることができます。
    ```
    $ cd ../biotools
    ```
    簡単な見分け方として先頭が "/" から始まる場合には絶対パス、それ以外は相対パスです。


5. __ディレクトリの作成と削除__

    練習用ディレクトリに移動します。
    ```
    $ cd ~/basic_course_2020/linux_command
    $ pwd
    /home/XXXXXXX/basic_course_2020/linux_command
    ```
    
    - ディレクトリの新規作成
  
        `mkdir` コマンド (make directory) を使い "test" という名称のディレクトリを作ります。
        ```
        $ mkdir test
        ```
    - ディレクトリの削除
        ```
        $ rmdir test
        ```
        このコマンドは空のディレクトリに対してしか使用できません。
        ディレクトリとその中身のファイルも含めて削除する場合にはかわりに
        ```
        $ rm -r test
        ```
        コマンドを使用します。


6. __touchコマンドとrmコマンド (ファイル作成と消去)__

    touchコマンドを使い空のテキストファイル (a.txt) を作成します。
    ```
    $ touch a.txt
    ```
    なお、テキストファイルであることが目で見てわかりやすいように拡張子 ".txt" をつけていますが、Windows とは異なり、UNIXでは拡張子によってファイルの種類を認識することはなく、拡張子は必須ではありません（`touch a`で "a" という名称の空のファイルが作られます）

    ファイルの消去は `rm a.txt` とします。

7. __echo コマンド、cat コマンド、リダイレクト__

    `echoコマンド`： 文字列を画面に出力します
    ```
    $ echo Hello
    Hello
    ```

    `>` を使うと画面の出力をテキストファイルに書き込むことができます（リダイレクト）。
    ```
    $ echo Hello > a.txt
    ```
    "a.txt" がすでに存在していた場合、上書きされますので気をつけてください。

    `>>` で追加書き込みできます
    ```
    $ echo world >> a.txt
    ```

    他のコマンドの出力結果もファイルに書き込めます。
    ```
    $ ll > b.txt
    ```

    `catコマンド`：ファイルの中身を画面に出力します。
    ```
    $ cat a.txt
    ```
    cat コマンドは本来は複数のファイルを連結（concatenate）するコマンドです。
    ```
    $ cat a.txt b.txt > c.txt
    ```
    で a.txt と b.txt を連結し、その結果を c.txt に書き込みます。


8. __ワイルドカード__

    ワイルドカード ( `*` や `?` ) を使うとパターンにあったファイルに対して一括して処理を行うことができます。

    ".txt" で終わるファイルの一覧を表示
    ```
    $ ls *.txt
    ```
    `*` は 0 文字以上の任意の文字列を示します

    ```
    $ ls ?.txt
    ```
    `?` は任意の 1 文字を示します。
    ```
    $ ls ??.txt
    ```
    と打った場合には "ab.txt" や "XY.txt" にマッチしますが、"a.txt" にはマッチしません

    これまでに作成した ".txt" ファイルを削除します。
    ```
    $ rm *.txt
    ```
    (単に `rm *` と打つと全てのファイルが消えてしまいますのでご注意ください。
    また、`-r` オプションをつけて `rm -r *` を実行すると、カレントディレクトリ以下にあるファイルがすべて消えます。UNIXでは一度削除したファイルを復活させることはできませんので、使用する場合には注意してください）

9. __cpコマンド（ファイルのコピー）とmvコマンド（ファイルの移動）__

    a.txtをAディレクトリに移動します。
    $ mv a.txt test1/
    (最後の/はなくても構いません）

    b.txtをBディレクトリにコピーします。
    $ cp b.txt test2/
    (最後の/はなくても構いません）

    ファイルを別名で複製することもできます。
    b.txtをb2.txtとして複製します
    $ cp b.txt b2.txt

    mvコマンドはファイル名を変更するときにも使用します。
    b.txtをc.txtに名前を変えます
    $ mv b.txt c.txt

    test2に移動します
    $ test2
    一つ上のディレクトリにある c.txt をカレントディレクトリに移動します。
    $ mv ../c.txt ./
    結果的に b.txtとb2.txtとc.txtの両方がカレントディレクトリに存在するはずです。

    mvやcpで複数のファイルやディレクトリを同時に移動・コピーすることも可能です。（講義では省略）


10.	__headコマンドとtailコマンド, wcコマンド__

    `head` と `tail` はそれぞれファイルの先頭および末端部分を表示します。  

    テスト用データに移動します。
    ```
    $ cd ../test1
    $ pwd
    /home/XXXXXX/basic_course_2020/linux_command/test1
    ```

    先頭から10行を抽出して表示します。
    ```
    $ head test1-1.gbk
    ```

    行数を指定することも可能です。
    ```
    $ head -100 test1-1.gbk
    ```

    末端から100行を抽出し、ファイルに書き込みます。
    ```
    $ tail -100 test1-2.gff > out.txt
    ```

    `wc`コマンドは行数・字数を出力します。
    ```
    $ wc test1-1.gbk
    ```
    表示される数値は順に、行数、単語数、文字数を表します。文字数には改行コードも含まれます。

    `-l` をつけると行数のみ表示します
    ```
    $ wc -l test1-1.gbk
    ```

11.	__less コマンド とmoreコマンド__

    `cat` コマンドはファイルの中身を一気に表示させるのに対し、大きなファイルを部分ごとに表示させるのが `less` や `more` コマンドです。
    less と more は多少の違いはありますが、less は moreの拡張版ですので less を使うことの方が多いです。

    ```
    $ less test1-1.gbk
    ```
    で起動します。
    矢印キーの上下左右でスクロール。"f" と "b" で１画面ずつ上下にスクロールします。

    "h" でヘルプが表示できます。"q" でlessを終了します。

    参考）
    less コマンドは、デフォルトでは画面の右端で自動的に折り返されて表示されます。この設定を無視して画面１行にファイルの内容を１行ずつ表示させる場合には `-S` オプションを使用します。`less -S read.fastq`

12.	__パイプ__

    `|` を使うとコマンドの出力を他のコマンドに連結することができます（読み方はパイプ、パイプライン、バーチカルバーなど）。

    例）ファイルの先頭100行を抽出した後、その末尾10行を表示させます。
    ```
    $ head -100 test1-1.gbk | tail -10 
    ```
    結果的に91行目から100行目が抽出されて表示されます。

    複数のパイプを連結することも可能です。
    例）上記の結果に対して wc を実行します。
    ```
    $ head -100 test1-1.gbk | tail -10 | wc
    ```
 

13.	ファイル内の検索 （grep）

    ファイルの中から文字列 "LOCUS" を含んだ行を表示させます。
    ```
    $ grep LOCUS test1-1.gbk
    ```
    パイプと組み合わせて使用することもできます
    使用例）
    スパコンの実行中ジョブの一覧から待機状態(qw)状態のジョブを表示させる。
    ```
    $ qstat -u "*" | grep qw
    ```

14.	プログラムの実行（パスを通す）

    (あらかじめ練習用のディレクトリに移動しておきます。)
    ```
    $ cd ~/basic_course/linux_command_2020/
    ```
    この中にある `hello` というプログラム（画面に "Hello world!" と表示されるだけのプログラム）を実行する方法を説明します。
    
    はじめにプログラムに実行権限を与えます（`chmod`コマンドについては補遺を参照）
    ```
    $ chmod a+x hello
    ```

    実行方法は 3 通りあります。
    - 相対パスで実行  
        ```
        $ ./hello
        ```
        カレントディレクトリにあるプログラムを実行する場合には明示的に "./" をつける必要があります。
    - 絶対パスで実行
        ```
        $ /home/XXXXXXX/basic_course_2020/linux_command/hello
        ```
        または
        ```
        $ ~/basic_course_2020/linux_command/hello
        ```
        ("~" はホームディレクトリを指す)
    - パス（PATH）を通す  
        パスとは、コマンド検索パスを意味します。あるコマンドを実行するためには、そのコマンドの存在するディレクトリが環境変数 `PATH` で指定されている必要があります。
        ```
        $ printenv PATH
        ```
        を実行すると現在の設定が確認できます。(`echo $PATH`でもOK)

        設定を変えるには `export` コマンドを使います。下記は現在いるディレクトリ（~/basic_course_2020/linux_command）をパスに加える方法です。
        ```
        $ export PATH=~/basic_course_2020/linux_command:$PATH
        ```
        これで `hello` コマンドを打つだけでプログラムが実行できるようになりました。このように環境変数 `PATHを` 設定し、コマンドを実行できるようにすることを「パスを通す」といいます。

        `hello` コマンドの実体がどこにあるかを示すには下記を実行します。
        ```
        $ which hello
        ~/basic_course_2020/linux_command/hello
        ```

        `export` コマンドで PATH の設定に失敗してしまうとコマンドが一切使えなくなってしまうことがありますが、その場合にはターミナルを閉じて再度ログインをすると回復します。

        参考1) 次のように`PATH`の後側に付け足すこともできます。`PATH`は先頭に近い方から探索されていくため、前につけた場合とは意味が若干異なります（同名のファイルがあった場合、先にみつかった方が優先されます）。

        ```
        $ export PATH=$PATH:~/basic_course_2020/linux_command
        ```

        参考２）ログアウトすると `export` コマンドで設定した環境変数の内容は失われてしまいますので、ログインごとに再設定する必要があります。頻繁に使うツールについては、`export` コマンドを ".bash_profile" ファイル（または ".bashrc" ファイル）の中に記述するとログイン時に自動で設定されるようになります。


15. Anaconda/Minicondaの導入とプログラムのインストール  

    別の資料参照

<hr>

## 補遺
以下は講習では扱いませんが、比較的よく使うコマンドやtipsを紹介します。

1. __wget インターネット上からファイルを取得する__

    URLを指定してインターネット上のファイルを取得します。
    例）DDBJのFTPサーバーからシークエンスデータを取得します。
    ```
    $ wget ftp://ftp.ddbj.nig.ac.jp//ddbj_database/dra/fastq/SRA117/SRA117449/SRX456287/SRR1151187_1.fastq.bz2
    ```

2. __ファイルの展開および圧縮__

    - zip 形式 → 展開 unzip、圧縮 zip  
    - gz 形式 → 展開 gunzip、圧縮 gzip  
    - bz2 形式 → 展開 bzip2、圧縮 bzip2  
    - tar or tar.gz 形式 → 展開および圧縮 tar コマンド  

    例) tar.gzファイルの展開
    ```
    $ tar xvfz archive_file.tar.gz
    ```
    "x" は展開（extract）、"v" は展開の過程を画面に表示（verbose）を表します。
    "z" は対象が gz 形式で圧縮されている場合につけますが、最近はつけなくても展開できます。
    "f" は展開する対象がファイルであることを示します。


3. __scp ローカルマシンとリモートサーバー（スパコン）との間でのファイルの転送を行う__

    以下はローカルマシン上で操作する例です。some_fileというファイルをスパコンのホームディレクトリにコピーします。
    ```
    $ scp some_file USERNAME@gw.ddbj.nig.ac.jp:~/
    ```
    スパコンからローカルマシンにコピーすることも可能です。

4. __パスワードの変更__
    ```
    $ passwd
    ```
    のあと、現在のパスワードを入力、
    続いて新しいパスワードを２回（確認のため）入力します。


5. __vi と emacs__

    どちらもターミナル上で動作するテキストエディタです。
    本講習ではSFTPクライアントソフトを使ってリモートのファイルを編集しますので、
    これらは使用しません。

    遺伝研スパコンを含め、一部のLinuxシステムではviが標準のエディタになっているため、
    最低限の操作方法は覚えておいた方が良いです。

    起動
    ```
    $ vi
    ```
    または
    ```
    $ vi ファイル名
    ```

    viはコマンドモードと入力モードに分かれています。
    入力モードに切り替えるには "i" をコマンドモードに戻るときは "ESC" を押します。
    コマンドモードにおいて ":w" で保存、":q" で終了します。


6. __JAVA で作られたプログラムを動かすときの注意点__

    スパコン上でJAVAで作られたプログラムを動かす際に、
    ```
    $ java
    Error occurred during initialization of VM
    Could not allocate metaspace: 1073741824 bytes
    ```
    というようなエラーが表示されて動作しない場合があります。この場合には下記のように環境変数 `_JAVA_OPTIONS` を指定しておくとエラーが回避できます。

    ```
    export _JAVA_OPTIONS="-Xmx1g -XX:ParallelGCThreads=1"
    ```
    "1g" の部分は使用したいプログラムによっては "256m" "512m" or "2g" などにした方が良い場合があります。
    ```
    export _JAVA_OPTIONS="-XX:ParallelGCThreads=1"
    ```
    だけでも良いかもしれません。

    参考）
    https://supcom.hgc.jp/japanese/utili_info/manual/faq.html#2829



7. __qlogin時にパスワード入力を回避する__

    詳細は省きますが、パスワード認証のかわりに鍵認証を行うように設定します。  
    はじめに、
    ```
    $ ls ~/.ssh/id_rsa.pub
    ```
    を実行してみて、ファイルが存在していないことを確認します。ファイルが存在していなければ、
    ```
    $ ssh-keygen
    ```
    を実行します。ファイルの保存場所やパスフレーズを聞かれますが、すべてデフォルトのまま（空欄のまま）エンターキーを押します。
    "id_rsa.pub" ファイルがすでに存在していればこの操作は不要です。

    次に、以下のコマンドを実行します。
    ```
    $ cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    ```
    以上です。


8. __パーミッションの設定 (chmod)__

    ls -lでファイルの情報を表示させると、次のように先頭に
    rやwからなる10桁の文字列が表示されます。
    ```
    -rw-r--r--  1 ユーザー名  グループ名  0  3 15 14:45 a.txt
    ```
    これはファイルやディレクトリのパーミッションを示しています。

    最初の１文字目はファイル種別を表しており、
    "-" は通常のファイル、"l" はシンボリックリンク、"d" はディレクトリを示しています。

    2文字目から4文字目はファイルの所有者に対する権限、5文字目から7文字目は所有者と同じグループに属するユーザーに対する権限、8文字目から10文字目はそれ以外のユーザーに対する権限を表しています。

    - "-" 権限なし（数値で表すと0）
    - "r" 読み取り（数値で表すと4）
    - "w" 書き込み（数値で表すと2）
    - "x" 実行可能（ディレクトリの場合は中のファイルに対するアクセス権限）（数値で表すと1）

    たとえば、上記の "a.txt" の場合
    ファイルの所有者は読み書き両方ができ (4+2=6)、
    同一グループに属するユーザーおよびその他のユーザーは読み込みのみ可能(4)です。
    これを数値で表すと "644" となります。

    パーミッションを変更するには chmod コマンドを用います。
    たとえば、
    ```
    $ chmod a+x a.txt
    ```
    とすると、すべてのユーザ (a)に対し実行権限(x)を付与する(+)という意味になり、
    パーミッションは以下のようになります。
    ```
    -rwxr-xr-x   1 ユーザー名  グループ名     0  3 15 14:45 a.txt
    ```
    また、数値で直接指定することもでき、
    ```
    $ chmod 751 a.txt
    ```
    とすると、パーミッションは
    ```
    -rwxr-x---   1 tanizawa  staff     0  3 15 14:45 a.txt
    ```
    というようになります。



9.	新しいアプリケーションをインストールする (condaコマンドを使用しない場合)

    ほとんどのプログラムは管理者権限を持っていなくても自分のホームディレクトリにインストールして使用することが可能です。
    ソースコードをダウンロードして自分でコンパイル（＝実行可能なファイルを作成する）する場合もあれば、コンパイル済みの実行ファイル（バイナリファイル）をダウンロードする場合もあります。
    コンパイル済みのファイルをダウンロードする場合には、"Linux x86_64" 用のものであればスパコンで動作します。

    例）トランスクリプトームマッピングツール HISAT2 のインストール
    配布元：https://ccb.jhu.edu/software/hisat2/index.shtml  
    ソースコード：ftp://ftp.ccb.jhu.edu/pub/infphilo/hisat2/downloads/hisat2-2.1.0-source.zip  
    バイナリファイル：ftp://ftp.ccb.jhu.edu/pub/infphilo/hisat2/downloads/hisat2-2.1.0-Linux_x86_64.zip  

    下記はhisat2をコンパイルするときの手順例です。  

    ソースコード取得
    ```
    $ wget ftp://ftp.ccb.jhu.edu/pub/infphilo/hisat2/downloads/hisat2-2.1.0-source.zip
    ```

    展開
    ```
    $ unzip hisat2-2.1.0-source.zip 
    ```
    ディレクトリに移動
    ```
    $ cd hisat2-2.1.0
    ```
    インストールの手順を確認する。最初に読むべき重要なファイルは “README" のように大文字で記載されていることが多い。hisat2の場合は "MANUAL" がそれに該当する。
    マニュアルに従い、`make` コマンドでコンパイルを行う
    ```
    $ make
    ```
    以上でhisat2およびその関連プログラムがコンパイルできます。
    プログラムによっては make の前に `configure` コマンドを実行したり、make の後に `make install` を行うものもありますが、基本的にはマニュアルに従って行えばそれほど難しくはありません。


10.	プログラミング環境の構築（中級者以上）

    スパコンにはPythonやPerlなどのプログラミング言語がインストールされていますが、異なるバージョンや標準では用意されていないライブラリが必要になることがあります。このような場合に、ホームディレクトリに自分でプログラミング環境を整えておくと便利です。
    pyenvやplenvというツールを使うとプログラミング言語のインストールを簡単に行うことができ、また、異なるバージョンを切り替えて使用することも可能になります。インストール方法については pyenv, plenvなど各ツールで検索すると日本語の情報が多く得られますので参考にしてください。



